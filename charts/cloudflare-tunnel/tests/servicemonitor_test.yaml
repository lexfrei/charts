suite: test servicemonitor
templates:
  - servicemonitor.yaml
tests:
  - it: should not create servicemonitor by default
    set:
      cloudflare:
        account: "test-account"
        tunnelName: "test-tunnel"
        tunnelId: "test-id"
        secret: "test-secret"
    asserts:
      - hasDocuments:
          count: 0

  - it: should create servicemonitor when enabled
    set:
      cloudflare:
        account: "test-account"
        tunnelName: "test-tunnel"
        tunnelId: "test-id"
        secret: "test-secret"
      serviceMonitor:
        enabled: true
    asserts:
      - isKind:
          of: ServiceMonitor
      - equal:
          path: metadata.name
          value: RELEASE-NAME-cloudflare-tunnel

  - it: should set correct selector
    set:
      cloudflare:
        account: "test-account"
        tunnelName: "test-tunnel"
        tunnelId: "test-id"
        secret: "test-secret"
      serviceMonitor:
        enabled: true
    asserts:
      - isNotNull:
          path: spec.selector.matchLabels

  - it: should configure custom interval
    set:
      cloudflare:
        account: "test-account"
        tunnelName: "test-tunnel"
        tunnelId: "test-id"
        secret: "test-secret"
      serviceMonitor:
        enabled: true
        interval: "60s"
    asserts:
      - equal:
          path: spec.endpoints[0].interval
          value: "60s"

  - it: should add metric relabelings
    set:
      cloudflare:
        account: "test-account"
        tunnelName: "test-tunnel"
        tunnelId: "test-id"
        secret: "test-secret"
      serviceMonitor:
        enabled: true
        metricRelabelings:
          - sourceLabels: [__name__]
            regex: "cloudflared_.*"
            action: keep
    asserts:
      - contains:
          path: spec.endpoints[0].metricRelabelings
          content:
            sourceLabels: [__name__]
            regex: "cloudflared_.*"
            action: keep

  - it: should add relabelings
    set:
      cloudflare:
        account: "test-account"
        tunnelName: "test-tunnel"
        tunnelId: "test-id"
        secret: "test-secret"
      serviceMonitor:
        enabled: true
        relabelings:
          - sourceLabels: [__meta_kubernetes_pod_name]
            targetLabel: pod
    asserts:
      - contains:
          path: spec.endpoints[0].relabelings
          content:
            sourceLabels: [__meta_kubernetes_pod_name]
            targetLabel: pod

  - it: should set job label
    set:
      cloudflare:
        account: "test-account"
        tunnelName: "test-tunnel"
        tunnelId: "test-id"
        secret: "test-secret"
      serviceMonitor:
        enabled: true
        jobLabel: "app.kubernetes.io/name"
    asserts:
      - equal:
          path: spec.jobLabel
          value: "app.kubernetes.io/name"
