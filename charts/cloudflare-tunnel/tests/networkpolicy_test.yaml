suite: test networkpolicy
templates:
  - networkpolicy.yaml
tests:
  # Basic NetworkPolicy tests
  - it: should not create NetworkPolicy by default
    set:
      cloudflare:
        account: test
        tunnelName: test
        tunnelId: test
        secret: test
    asserts:
      - hasDocuments:
          count: 0

  - it: should create NetworkPolicy when enabled
    set:
      cloudflare:
        account: test
        tunnelName: test
        tunnelId: test
        secret: test
      networkPolicy.enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: NetworkPolicy
      - equal:
          path: apiVersion
          value: networking.k8s.io/v1

  # Metadata tests
  - it: should have correct name and labels
    set:
      cloudflare:
        account: test
        tunnelName: test
        tunnelId: test
        secret: test
      networkPolicy.enabled: true
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-cloudflare-tunnel
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: cloudflare-tunnel

  # Pod selector tests
  - it: should select pods with correct labels
    set:
      cloudflare:
        account: test
        tunnelName: test
        tunnelId: test
        secret: test
      networkPolicy.enabled: true
    asserts:
      - equal:
          path: spec.podSelector.matchLabels["app.kubernetes.io/name"]
          value: cloudflare-tunnel
      - equal:
          path: spec.podSelector.matchLabels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  # Policy types tests
  - it: should include both Ingress and Egress policy types
    set:
      cloudflare:
        account: test
        tunnelName: test
        tunnelId: test
        secret: test
      networkPolicy.enabled: true
    asserts:
      - contains:
          path: spec.policyTypes
          content: Ingress
      - contains:
          path: spec.policyTypes
          content: Egress

  # Ingress rules tests
  - it: should not have ingress section by default
    set:
      cloudflare:
        account: test
        tunnelName: test
        tunnelId: test
        secret: test
      networkPolicy.enabled: true
    asserts:
      - isNull:
          path: spec.ingress

  - it: should add custom ingress rules
    set:
      cloudflare:
        account: test
        tunnelName: test
        tunnelId: test
        secret: test
      networkPolicy:
        enabled: true
        ingress:
          - from:
              - podSelector:
                  matchLabels:
                    app: monitoring
            ports:
              - protocol: TCP
                port: 2000
    asserts:
      - lengthEqual:
          path: spec.ingress
          count: 1
      - equal:
          path: spec.ingress[0].from[0].podSelector.matchLabels.app
          value: monitoring
      - equal:
          path: spec.ingress[0].ports[0].port
          value: 2000

  - it: should support multiple ingress rules
    set:
      cloudflare:
        account: test
        tunnelName: test
        tunnelId: test
        secret: test
      networkPolicy:
        enabled: true
        ingress:
          - from:
              - podSelector:
                  matchLabels:
                    app: prometheus
          - from:
              - namespaceSelector:
                  matchLabels:
                    name: monitoring
    asserts:
      - lengthEqual:
          path: spec.ingress
          count: 2

  - it: should support ingress from specific IPs
    set:
      cloudflare:
        account: test
        tunnelName: test
        tunnelId: test
        secret: test
      networkPolicy:
        enabled: true
        ingress:
          - from:
              - ipBlock:
                  cidr: 192.168.0.0/16
                  except:
                    - 192.168.1.0/24
    asserts:
      - equal:
          path: spec.ingress[0].from[0].ipBlock.cidr
          value: 192.168.0.0/16
      - contains:
          path: spec.ingress[0].from[0].ipBlock.except
          content: 192.168.1.0/24

  # Egress rules tests
  - it: should have default egress rules
    set:
      cloudflare:
        account: test
        tunnelName: test
        tunnelId: test
        secret: test
      networkPolicy.enabled: true
    asserts:
      - lengthEqual:
          path: spec.egress
          count: 2

  - it: should allow DNS egress
    set:
      cloudflare:
        account: test
        tunnelName: test
        tunnelId: test
        secret: test
      networkPolicy.enabled: true
    asserts:
      - contains:
          path: spec.egress[0].ports
          content:
            protocol: UDP
            port: 53

  - it: should allow Cloudflare egress
    set:
      cloudflare:
        account: test
        tunnelName: test
        tunnelId: test
        secret: test
      networkPolicy.enabled: true
    asserts:
      - contains:
          path: spec.egress[1].ports
          content:
            protocol: TCP
            port: 443
      - equal:
          path: spec.egress[1].to[0].namespaceSelector
          value: {}

  - it: should add custom egress rules
    set:
      cloudflare:
        account: test
        tunnelName: test
        tunnelId: test
        secret: test
      networkPolicy:
        enabled: true
        egress:
          - to:
              - podSelector:
                  matchLabels:
                    app: backend
            ports:
              - protocol: TCP
                port: 8080
    asserts:
      - lengthEqual:
          path: spec.egress
          count: 3
      - equal:
          path: spec.egress[2].to[0].podSelector.matchLabels.app
          value: backend

  - it: should support multiple custom egress rules
    set:
      cloudflare:
        account: test
        tunnelName: test
        tunnelId: test
        secret: test
      networkPolicy:
        enabled: true
        egress:
          - to:
              - podSelector:
                  matchLabels:
                    app: db
          - to:
              - podSelector:
                  matchLabels:
                    app: cache
    asserts:
      - lengthEqual:
          path: spec.egress
          count: 4

  # Edge cases
  - it: should handle empty ingress and egress arrays
    set:
      cloudflare:
        account: test
        tunnelName: test
        tunnelId: test
        secret: test
      networkPolicy:
        enabled: true
        ingress: []
        egress: []
    asserts:
      - isNull:
          path: spec.ingress
      - lengthEqual:
          path: spec.egress
          count: 2

  - it: should support complex port definitions
    set:
      cloudflare:
        account: test
        tunnelName: test
        tunnelId: test
        secret: test
      networkPolicy:
        enabled: true
        ingress:
          - ports:
              - protocol: TCP
                port: 80
              - protocol: TCP
                port: 443
              - protocol: TCP
                port: 8080
    asserts:
      - lengthEqual:
          path: spec.ingress[0].ports
          count: 3

  - it: should support multiple sources in single rule
    set:
      cloudflare:
        account: test
        tunnelName: test
        tunnelId: test
        secret: test
      networkPolicy:
        enabled: true
        ingress:
          - from:
              - podSelector:
                  matchLabels:
                    role: frontend
              - namespaceSelector:
                  matchLabels:
                    name: prod
              - ipBlock:
                  cidr: 10.0.0.0/8
    asserts:
      - lengthEqual:
          path: spec.ingress[0].from
          count: 3

  - it: should work with DaemonSet mode
    set:
      cloudflare:
        account: test
        tunnelName: test
        tunnelId: test
        secret: test
      deploymentMode: daemonset
      networkPolicy.enabled: true
    asserts:
      - isKind:
          of: NetworkPolicy

  - it: should respect fullnameOverride
    set:
      cloudflare:
        account: test
        tunnelName: test
        tunnelId: test
        secret: test
      fullnameOverride: custom-tunnel
      networkPolicy.enabled: true
    asserts:
      - equal:
          path: metadata.name
          value: custom-tunnel
