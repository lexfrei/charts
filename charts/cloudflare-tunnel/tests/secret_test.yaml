suite: test secret
templates:
  - secret.yaml
tests:
  - it: should create secret with tunnel credentials
    set:
      cloudflare:
        account: "test-account"
        tunnelName: "test-tunnel"
        tunnelId: "test-tunnel-id"
        secret: "test-secret-value"
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-cloudflare-tunnel
      - isNotNull:
          path: stringData["credentials.json"]

  - it: should not create secret when secretName is provided
    set:
      cloudflare:
        account: "test-account"
        tunnelName: "test-tunnel"
        tunnelId: "test-tunnel-id"
        secret: "test-secret-value"
        secretName: "existing-secret"
    asserts:
      - hasDocuments:
          count: 0

  - it: should include correct credentials structure
    set:
      cloudflare:
        account: "my-account"
        tunnelName: "my-tunnel"
        tunnelId: "my-tunnel-id"
        secret: "my-secret"
    asserts:
      - matchRegex:
          path: stringData["credentials.json"]
          pattern: '"AccountTag".*"my-account"'
      - matchRegex:
          path: stringData["credentials.json"]
          pattern: '"TunnelID".*"my-tunnel-id"'
      - matchRegex:
          path: stringData["credentials.json"]
          pattern: '"TunnelSecret".*"my-secret"'
