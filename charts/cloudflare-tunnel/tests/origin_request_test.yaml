suite: test originRequest configuration
templates:
  - configmap.yaml
  - secret.yaml
values:
  - ../values.yaml
tests:
  - it: should not include originRequest by default
    set:
      cloudflare:
        account: test-account
        tunnelName: test-tunnel
        tunnelId: test-id
        secret: test-secret
        ingress:
          - hostname: test.example.com
            service: http://test-service:80
    asserts:
      - template: configmap.yaml
        notMatchRegex:
          path: data["config.yaml"]
          pattern: "originRequest:"

  - it: should add global originRequest when specified
    set:
      cloudflare:
        account: test-account
        tunnelName: test-tunnel
        tunnelId: test-id
        secret: test-secret
        ingress:
          - hostname: test.example.com
            service: http://test-service:80
        originRequest:
          connectTimeout: 30s
          noTLSVerify: false
    asserts:
      - template: configmap.yaml
        matchRegex:
          path: data["config.yaml"]
          pattern: "originRequest:"
      - template: configmap.yaml
        matchRegex:
          path: data["config.yaml"]
          pattern: "connectTimeout: 30s"

  - it: should support http2Origin setting
    set:
      cloudflare:
        account: test-account
        tunnelName: test-tunnel
        tunnelId: test-id
        secret: test-secret
        ingress:
          - hostname: test.example.com
            service: http://test-service:80
        originRequest:
          http2Origin: true
    asserts:
      - template: configmap.yaml
        matchRegex:
          path: data["config.yaml"]
          pattern: "http2Origin: true"

  - it: should support noTLSVerify setting
    set:
      cloudflare:
        account: test-account
        tunnelName: test-tunnel
        tunnelId: test-id
        secret: test-secret
        ingress:
          - hostname: test.example.com
            service: http://test-service:80
        originRequest:
          noTLSVerify: true
    asserts:
      - template: configmap.yaml
        matchRegex:
          path: data["config.yaml"]
          pattern: "noTLSVerify: true"

  - it: should support multiple originRequest settings
    set:
      cloudflare:
        account: test-account
        tunnelName: test-tunnel
        tunnelId: test-id
        secret: test-secret
        ingress:
          - hostname: test.example.com
            service: http://test-service:80
        originRequest:
          connectTimeout: 30s
          tlsTimeout: 10s
          keepAliveTimeout: 90s
          noHappyEyeballs: false
          http2Origin: true
    asserts:
      - template: configmap.yaml
        matchRegex:
          path: data["config.yaml"]
          pattern: "connectTimeout: 30s"
      - template: configmap.yaml
        matchRegex:
          path: data["config.yaml"]
          pattern: "tlsTimeout: 10s"
      - template: configmap.yaml
        matchRegex:
          path: data["config.yaml"]
          pattern: "keepAliveTimeout: 90s"

  - it: should support per-ingress originRequest (overrides global)
    set:
      cloudflare:
        account: test-account
        tunnelName: test-tunnel
        tunnelId: test-id
        secret: test-secret
        originRequest:
          connectTimeout: 30s
        ingress:
          - hostname: test.example.com
            service: http://test-service:80
            originRequest:
              connectTimeout: 60s
              noTLSVerify: true
    asserts:
      - template: configmap.yaml
        matchRegex:
          path: data["config.yaml"]
          pattern: "connectTimeout: 60s"
      - template: configmap.yaml
        matchRegex:
          path: data["config.yaml"]
          pattern: "noTLSVerify: true"
