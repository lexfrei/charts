suite: test customizable liveness probe
templates:
  - deployment.yaml
  - configmap.yaml
  - secret.yaml
values:
  - ../values.yaml
tests:
  - it: should use default liveness probe settings
    set:
      cloudflare:
        account: test-account
        tunnelName: test-tunnel
        tunnelId: test-id
        secret: test-secret
        ingress:
          - hostname: test.example.com
            service: http://test-service:80
    asserts:
      - template: deployment.yaml
        equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /ready
      - template: deployment.yaml
        equal:
          path: spec.template.spec.containers[0].livenessProbe.failureThreshold
          value: 1
      - template: deployment.yaml
        equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 30
      - template: deployment.yaml
        equal:
          path: spec.template.spec.containers[0].livenessProbe.periodSeconds
          value: 10

  - it: should allow custom failureThreshold
    set:
      cloudflare:
        account: test-account
        tunnelName: test-tunnel
        tunnelId: test-id
        secret: test-secret
        ingress:
          - hostname: test.example.com
            service: http://test-service:80
      livenessProbe:
        failureThreshold: 3
    asserts:
      - template: deployment.yaml
        equal:
          path: spec.template.spec.containers[0].livenessProbe.failureThreshold
          value: 3

  - it: should allow custom initialDelaySeconds
    set:
      cloudflare:
        account: test-account
        tunnelName: test-tunnel
        tunnelId: test-id
        secret: test-secret
        ingress:
          - hostname: test.example.com
            service: http://test-service:80
      livenessProbe:
        initialDelaySeconds: 30
    asserts:
      - template: deployment.yaml
        equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 30

  - it: should allow custom periodSeconds
    set:
      cloudflare:
        account: test-account
        tunnelName: test-tunnel
        tunnelId: test-id
        secret: test-secret
        ingress:
          - hostname: test.example.com
            service: http://test-service:80
      livenessProbe:
        periodSeconds: 30
    asserts:
      - template: deployment.yaml
        equal:
          path: spec.template.spec.containers[0].livenessProbe.periodSeconds
          value: 30

  - it: should allow custom timeoutSeconds
    set:
      cloudflare:
        account: test-account
        tunnelName: test-tunnel
        tunnelId: test-id
        secret: test-secret
        ingress:
          - hostname: test.example.com
            service: http://test-service:80
      livenessProbe:
        timeoutSeconds: 5
    asserts:
      - template: deployment.yaml
        equal:
          path: spec.template.spec.containers[0].livenessProbe.timeoutSeconds
          value: 5

  - it: should allow multiple probe settings at once
    set:
      cloudflare:
        account: test-account
        tunnelName: test-tunnel
        tunnelId: test-id
        secret: test-secret
        ingress:
          - hostname: test.example.com
            service: http://test-service:80
      livenessProbe:
        failureThreshold: 5
        initialDelaySeconds: 20
        periodSeconds: 15
        timeoutSeconds: 3
    asserts:
      - template: deployment.yaml
        equal:
          path: spec.template.spec.containers[0].livenessProbe.failureThreshold
          value: 5
      - template: deployment.yaml
        equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 20
      - template: deployment.yaml
        equal:
          path: spec.template.spec.containers[0].livenessProbe.periodSeconds
          value: 15
      - template: deployment.yaml
        equal:
          path: spec.template.spec.containers[0].livenessProbe.timeoutSeconds
          value: 3
