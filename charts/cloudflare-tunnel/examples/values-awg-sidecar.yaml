# Example: Cloudflare Tunnel with AmneziaWG Sidecar
#
# Both containers share the same network namespace.
#
# Prerequisites:
# 1. Create config secret:
#    kubectl create secret generic awg-config \
#      --from-file=wg0.conf=/path/to/your/config.conf \
#      --namespace=cloudflared-system
#
# 2. Create tunnel credentials secret (if not using cloudflare.secret):
#    kubectl create secret generic tunnel-credentials \
#      --from-file=credentials.json=/path/to/credentials.json \
#      --namespace=cloudflared-system
#
# 3. If using Kyverno, create PolicyException for privileged container

cloudflare:
  account: "your-account-id"
  tunnelName: "your-tunnel-name"
  tunnelId: "your-tunnel-id"
  # Use external secret for credentials
  secretName: tunnel-credentials
  ingress:
    - hostname: app.example.com
      service: http://my-service.my-namespace.svc.cluster.local:80
  enableDefault404: true

replicaCount: 1

podSecurityContext:
  runAsNonRoot: false
  seccompProfile:
    type: RuntimeDefault

sidecar:
  initContainers:
    - name: wait-for-sidecar
      image: busybox:1.36
      command:
        - sh
        - -c
        - |
          echo "Waiting for sidecar..."
          sleep 5
          echo "Done"
      securityContext:
        runAsUser: 0
        runAsNonRoot: false

  containers:
    - name: amneziawg
      image: ghcr.io/zeozeozeo/amneziawg-client:latest
      imagePullPolicy: IfNotPresent
      stdin: true
      tty: true
      securityContext:
        privileged: true
        runAsUser: 0
        runAsNonRoot: false
      volumeMounts:
        - name: awg-config
          mountPath: /config
          readOnly: true
        - name: tun-device
          mountPath: /dev/net/tun
      resources:
        requests:
          cpu: 10m
          memory: 32Mi
        limits:
          memory: 64Mi

  extraVolumes:
    - name: awg-config
      secret:
        secretName: awg-config
    - name: tun-device
      hostPath:
        path: /dev/net/tun
        type: CharDevice

logLevel: info
