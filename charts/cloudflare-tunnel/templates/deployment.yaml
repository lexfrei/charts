{{- if eq .Values.deploymentMode "deployment" }}
{{- if and .Values.postQuantum (eq .Values.protocol "http2") }}
{{- fail "postQuantum cannot be enabled with http2 protocol. Use 'auto' or 'quic' instead." }}
{{- end }}
{{- if eq .Values.cloudflare.mode "remote" }}
{{- if and (not .Values.cloudflare.tunnelToken) (not .Values.cloudflare.tunnelTokenSecretName) }}
{{- fail "cloudflare.tunnelToken or cloudflare.tunnelTokenSecretName is required when mode is 'remote'" }}
{{- end }}
{{- end }}
# Here we deploy cloudflared images.
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "cloudflare-tunnel.fullname" . }}
  labels:
    {{- include "cloudflare-tunnel.labels" . | nindent 4 }}
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "cloudflare-tunnel.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      annotations:
        # These are here so the deployment rolls when the config or secret change.
        checksum/configmap: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
        checksum/secret: {{ include (print $.Template.BasePath "/secret.yaml") . | sha256sum }}
        {{- with .Values.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      labels:
        {{- include "cloudflare-tunnel.selectorLabels" . | nindent 8 }}
        {{- with .Values.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if .Values.priorityClassName }}
      priorityClassName: {{ .Values.priorityClassName }}
      {{- end }}
      serviceAccountName: {{ include "cloudflare-tunnel.fullname" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      {{- with .Values.sidecar.initContainers }}
      initContainers:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: {{ .Chart.Name }}
          securityContext:
            {{- toYaml .Values.securityContext | nindent 12 }}
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          {{- if or (eq .Values.cloudflare.mode "remote") (and .Values.logLevel (ne .Values.logLevel "")) (and .Values.protocol (ne .Values.protocol "")) .Values.postQuantum (and .Values.region (ne .Values.region "")) (and .Values.retries (ne .Values.retries "")) (and .Values.edgeIpVersion (ne .Values.edgeIpVersion "")) (and .Values.gracePeriod (ne .Values.gracePeriod "")) (and .Values.edgeBindAddress (ne .Values.edgeBindAddress "")) (and .Values.tags (gt (len .Values.tags) 0)) }}
          env:
            {{- if eq .Values.cloudflare.mode "remote" }}
            - name: TUNNEL_TOKEN
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.cloudflare.tunnelTokenSecretName | default (printf "%s-token" (include "cloudflare-tunnel.fullname" .)) }}
                  key: token
            - name: TUNNEL_METRICS
              value: "0.0.0.0:{{ .Values.metricsPort }}"
            {{- end }}
            {{- if and .Values.logLevel (ne .Values.logLevel "") }}
            - name: TUNNEL_LOGLEVEL
              value: {{ .Values.logLevel }}
            {{- end }}
            {{- if and .Values.protocol (ne .Values.protocol "") }}
            - name: TUNNEL_TRANSPORT_PROTOCOL
              value: {{ .Values.protocol }}
            {{- end }}
            {{- if .Values.postQuantum }}
            - name: TUNNEL_POST_QUANTUM
              value: "true"
            {{- end }}
            {{- if and .Values.region (ne .Values.region "") }}
            - name: TUNNEL_REGION
              value: {{ .Values.region | quote }}
            {{- end }}
            {{- if and .Values.retries (ne .Values.retries "") }}
            - name: TUNNEL_RETRIES
              value: {{ .Values.retries | quote }}
            {{- end }}
            {{- if and .Values.edgeIpVersion (ne .Values.edgeIpVersion "") }}
            - name: TUNNEL_EDGE_IP_VERSION
              value: {{ .Values.edgeIpVersion | quote }}
            {{- end }}
            {{- if and .Values.gracePeriod (ne .Values.gracePeriod "") }}
            - name: TUNNEL_GRACE_PERIOD
              value: {{ .Values.gracePeriod | quote }}
            {{- end }}
            {{- if and .Values.edgeBindAddress (ne .Values.edgeBindAddress "") }}
            - name: TUNNEL_EDGE_BIND_ADDRESS
              value: {{ .Values.edgeBindAddress | quote }}
            {{- end }}
            {{- if and .Values.tags (gt (len .Values.tags) 0) }}
            - name: TUNNEL_TAG
              value: {{ $tags := list }}{{- range $key, $value := .Values.tags }}{{ $tags = append $tags (printf "%s=%s" $key $value) }}{{- end }}{{ join "," $tags }}
            {{- end }}
          {{- end }}
          args:
            - tunnel
            {{- if eq .Values.cloudflare.mode "remote" }}
            - run
            - --token
            - $(TUNNEL_TOKEN)
            {{- else }}
            - --config
            - /etc/cloudflared/config/config.yaml
            - run
            {{- end }}
          livenessProbe:
            httpGet:
              # Cloudflared has a /ready endpoint which returns 200 if and only if
              # it has an active connection to the edge.
              path: /ready
              port: {{ .Values.metricsPort }}
            failureThreshold: {{ .Values.livenessProbe.failureThreshold }}
            initialDelaySeconds: {{ .Values.livenessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.livenessProbe.periodSeconds }}
            {{- with .Values.livenessProbe.timeoutSeconds }}
            timeoutSeconds: {{ . }}
            {{- end }}
          {{- if or (ne .Values.cloudflare.mode "remote") .Values.sidecar.extraVolumeMounts }}
          volumeMounts:
            {{- if ne .Values.cloudflare.mode "remote" }}
            - name: config
              mountPath: /etc/cloudflared/config
              readOnly: true
            - name: creds
              mountPath: /etc/cloudflared/creds
              readOnly: true
            {{- end }}
            {{- with .Values.sidecar.extraVolumeMounts }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
          {{- end }}
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
        {{- with .Values.sidecar.containers }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      {{- if or (ne .Values.cloudflare.mode "remote") .Values.sidecar.extraVolumes }}
      volumes:
        {{- if ne .Values.cloudflare.mode "remote" }}
        - name: creds
          secret:
            secretName: {{ .Values.cloudflare.secretName | default (include "cloudflare-tunnel.fullname" .) }}
        - name: config
          configMap:
            name: {{ include "cloudflare-tunnel.fullname" . }}
            items:
              - key: config.yaml
                path: config.yaml
        {{- end }}
        {{- with .Values.sidecar.extraVolumes }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      affinity:
        {{- with .Values.affinity }}
        {{- toYaml . | nindent 8 }}
        {{- else }}
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 10
              podAffinityTerm:
                topologyKey: kubernetes.io/hostname
                labelSelector:
                  matchExpressions:
                  {{- range $k, $v := include "cloudflare-tunnel.selectorLabels" . | fromYaml }}
                    - key: {{ $k }}
                      operator: In
                      values:
                        - {{ $v }}
                  {{- end }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.topologySpreadConstraints }}
      topologySpreadConstraints:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}
