suite: test httproute
templates:
  - httproute.yaml
tests:
  - it: should not create HTTPRoute by default
    asserts:
      - hasDocuments:
          count: 0

  - it: should create HTTPRoute when enabled
    set:
      httpRoute.enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: HTTPRoute
      - equal:
          path: apiVersion
          value: gateway.networking.k8s.io/v1

  - it: should have correct metadata
    set:
      httpRoute.enabled: true
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-transmission
      - isNotEmpty:
          path: metadata.labels

  - it: should include standard labels
    set:
      httpRoute.enabled: true
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: transmission
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  - it: should set parentRefs correctly
    set:
      httpRoute.enabled: true
      httpRoute.parentRefs:
        - name: my-gateway
          namespace: custom-namespace
    asserts:
      - equal:
          path: spec.parentRefs[0].name
          value: my-gateway
      - equal:
          path: spec.parentRefs[0].namespace
          value: custom-namespace

  - it: should set hostnames correctly
    set:
      httpRoute.enabled: true
      httpRoute.hostnames:
        - transmission.example.com
        - transmission.alt.com
    asserts:
      - contains:
          path: spec.hostnames
          content: transmission.example.com
      - contains:
          path: spec.hostnames
          content: transmission.alt.com

  - it: should have correct backendRef
    set:
      httpRoute.enabled: true
    asserts:
      - equal:
          path: spec.rules[0].backendRefs[0].name
          value: RELEASE-NAME-transmission
      - equal:
          path: spec.rules[0].backendRefs[0].port
          value: 9091

  - it: should use custom service port
    set:
      httpRoute.enabled: true
      service.web.port: 8080
    asserts:
      - equal:
          path: spec.rules[0].backendRefs[0].port
          value: 8080

  - it: should set path match correctly
    set:
      httpRoute.enabled: true
      httpRoute.rules:
        - matches:
            - path:
                type: PathPrefix
                value: /transmission
    asserts:
      - equal:
          path: spec.rules[0].matches[0].path.type
          value: PathPrefix
      - equal:
          path: spec.rules[0].matches[0].path.value
          value: /transmission

  - it: should support custom annotations
    set:
      httpRoute.enabled: true
      httpRoute.annotations:
        custom.annotation/key: "value"
        another.annotation: "test"
    asserts:
      - equal:
          path: metadata.annotations["custom.annotation/key"]
          value: "value"
      - equal:
          path: metadata.annotations["another.annotation"]
          value: "test"

  - it: should support filters
    set:
      httpRoute.enabled: true
      httpRoute.rules:
        - matches:
            - path:
                type: PathPrefix
                value: /
          filters:
            - type: RequestHeaderModifier
              requestHeaderModifier:
                add:
                  - name: X-Custom-Header
                    value: custom-value
    asserts:
      - equal:
          path: spec.rules[0].filters[0].type
          value: RequestHeaderModifier
      - equal:
          path: spec.rules[0].filters[0].requestHeaderModifier.add[0].name
          value: X-Custom-Header

  - it: should support weight in backendRef
    set:
      httpRoute.enabled: true
      httpRoute.rules:
        - matches:
            - path:
                type: PathPrefix
                value: /
          weight: 100
    asserts:
      - equal:
          path: spec.rules[0].backendRefs[0].weight
          value: 100

  - it: should support multiple rules
    set:
      httpRoute.enabled: true
      httpRoute.rules:
        - matches:
            - path:
                type: PathPrefix
                value: /api
        - matches:
            - path:
                type: PathPrefix
                value: /web
    asserts:
      - lengthEqual:
          path: spec.rules
          count: 2
      - equal:
          path: spec.rules[0].matches[0].path.value
          value: /api
      - equal:
          path: spec.rules[1].matches[0].path.value
          value: /web

  - it: should support Exact path match type
    set:
      httpRoute.enabled: true
      httpRoute.rules:
        - matches:
            - path:
                type: Exact
                value: /transmission
    asserts:
      - equal:
          path: spec.rules[0].matches[0].path.type
          value: Exact

  - it: should support RegularExpression path match type
    set:
      httpRoute.enabled: true
      httpRoute.rules:
        - matches:
            - path:
                type: RegularExpression
                value: "^/torrents/[0-9]+"
    asserts:
      - equal:
          path: spec.rules[0].matches[0].path.type
          value: RegularExpression
      - equal:
          path: spec.rules[0].matches[0].path.value
          value: "^/torrents/[0-9]+"

  - it: should support multiple parentRefs
    set:
      httpRoute.enabled: true
      httpRoute.parentRefs:
        - name: gateway-1
          namespace: ns1
        - name: gateway-2
          namespace: ns2
    asserts:
      - lengthEqual:
          path: spec.parentRefs
          count: 2
      - equal:
          path: spec.parentRefs[0].name
          value: gateway-1
      - equal:
          path: spec.parentRefs[1].name
          value: gateway-2

  - it: should support sectionName in parentRefs
    set:
      httpRoute.enabled: true
      httpRoute.parentRefs:
        - name: cilium-gateway-internal
          namespace: kube-system
          sectionName: https-home-lex-la
    asserts:
      - equal:
          path: spec.parentRefs[0].name
          value: cilium-gateway-internal
      - equal:
          path: spec.parentRefs[0].namespace
          value: kube-system
      - equal:
          path: spec.parentRefs[0].sectionName
          value: https-home-lex-la

  - it: should not have filters when not specified
    set:
      httpRoute.enabled: true
    asserts:
      - isNull:
          path: spec.rules[0].filters
