suite: test statefulset
templates:
  - statefulset.yaml
tests:
  - it: should create StatefulSet
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: StatefulSet
      - equal:
          path: metadata.name
          value: RELEASE-NAME-transmission

  - it: should have single replica
    asserts:
      - equal:
          path: spec.replicas
          value: 1

  - it: should have correct serviceName
    asserts:
      - equal:
          path: spec.serviceName
          value: RELEASE-NAME-transmission

  - it: should use correct image
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^linuxserver/transmission:[0-9]+\.[0-9]+\.[0-9]+$

  - it: should expose all ports
    asserts:
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: http
            containerPort: 9091
            protocol: TCP
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: torrent-tcp
            containerPort: 51413
            protocol: TCP
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: torrent-udp
            containerPort: 51413
            protocol: UDP

  - it: should set environment variables
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: PUID
            value: "1000"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: PGID
            value: "1000"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: TZ
            value: "Europe/Moscow"

  - it: should set security context
    asserts:
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 1000
      - equal:
          path: spec.template.spec.securityContext.seccompProfile.type
          value: RuntimeDefault

  - it: should not have initContainers by default
    asserts:
      - isNull:
          path: spec.template.spec.initContainers

  - it: should render initContainers when specified
    set:
      initContainers:
        - name: init-permissions
          image: busybox:latest
          command: ['sh', '-c', 'echo "Init container running"']
    asserts:
      - isNotNull:
          path: spec.template.spec.initContainers
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: init-permissions
      - equal:
          path: spec.template.spec.initContainers[0].image
          value: busybox:latest
