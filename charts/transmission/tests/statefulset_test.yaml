suite: test statefulset
templates:
  - statefulset.yaml
tests:
  - it: should create StatefulSet
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: StatefulSet
      - equal:
          path: metadata.name
          value: RELEASE-NAME-transmission

  - it: should have single replica
    asserts:
      - equal:
          path: spec.replicas
          value: 1

  - it: should have correct serviceName
    asserts:
      - equal:
          path: spec.serviceName
          value: RELEASE-NAME-transmission

  - it: should use correct image
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^linuxserver/transmission:[0-9]+\.[0-9]+\.[0-9]+$

  - it: should expose all ports
    asserts:
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: http
            containerPort: 9091
            protocol: TCP
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: torrent-tcp
            containerPort: 51413
            protocol: TCP
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: torrent-udp
            containerPort: 51413
            protocol: UDP

  - it: should set environment variables
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: PUID
            value: "1000"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: PGID
            value: "1000"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: TZ
            value: "Europe/Moscow"

  - it: should set security context
    asserts:
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 1000
      - equal:
          path: spec.template.spec.securityContext.seccompProfile.type
          value: RuntimeDefault

  # Health probes tests
  - it: should have liveness probe with exec command and default values (runAsUser abc)
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.exec.command[0]
          value: sh
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.exec.command[1]
          value: -c
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.exec.command[2]
          value: "su -s /bin/sh - abc -c 'touch /downloads/.healthcheck && rm --force /downloads/.healthcheck' && curl --silent --fail --max-time 5 http://localhost:9091/transmission/web/ >/dev/null"
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 30
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.periodSeconds
          value: 10
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.timeoutSeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.failureThreshold
          value: 6

  - it: should run liveness probe as root when runAsUser is empty
    set:
      livenessProbe:
        runAsUser: ""
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.exec.command[2]
          value: "touch /downloads/.healthcheck && rm --force /downloads/.healthcheck && curl --silent --fail --max-time 5 http://localhost:9091/transmission/web/ >/dev/null"

  - it: should have readiness probe with default values
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /transmission/web/
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: http
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.initialDelaySeconds
          value: 10
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.periodSeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.timeoutSeconds
          value: 3
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.failureThreshold
          value: 3

  - it: should allow custom liveness probe values with custom runAsUser
    set:
      livenessProbe:
        runAsUser: "customuser"
        fsCheckPath: /data
        initialDelaySeconds: 60
        periodSeconds: 20
        timeoutSeconds: 10
        failureThreshold: 3
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.exec.command[2]
          value: "su -s /bin/sh - customuser -c 'touch /data/.healthcheck && rm --force /data/.healthcheck' && curl --silent --fail --max-time 5 http://localhost:9091/transmission/web/ >/dev/null"
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 60
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.periodSeconds
          value: 20
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.timeoutSeconds
          value: 10
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.failureThreshold
          value: 3

  - it: should allow custom readiness probe values
    set:
      readinessProbe:
        initialDelaySeconds: 5
        periodSeconds: 3
        timeoutSeconds: 2
        failureThreshold: 5
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.initialDelaySeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.periodSeconds
          value: 3
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.timeoutSeconds
          value: 2
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.failureThreshold
          value: 5

  - it: should not have initContainers by default
    asserts:
      - isNull:
          path: spec.template.spec.initContainers

  - it: should render initContainers when specified
    set:
      initContainers:
        - name: init-permissions
          image: busybox:latest
          command: ['sh', '-c', 'echo "Init container running"']
    asserts:
      - isNotNull:
          path: spec.template.spec.initContainers
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: init-permissions
      - equal:
          path: spec.template.spec.initContainers[0].image
          value: busybox:latest

  # Downloads volume tests
  - it: should use NFS volume when type is nfs
    set:
      persistence.downloads.type: nfs
      persistence.downloads.nfsServer: my-nfs-server.local
      persistence.downloads.nfsPath: /exports/downloads
      persistence.downloads.existingClaim: ""
    asserts:
      - equal:
          path: spec.template.spec.volumes[1].nfs.server
          value: my-nfs-server.local
      - equal:
          path: spec.template.spec.volumes[1].nfs.path
          value: /exports/downloads
      - isNull:
          path: spec.template.spec.volumes[1].persistentVolumeClaim

  - it: should use default PVC when type is pvc without existingClaim
    set:
      persistence.downloads.type: pvc
      persistence.downloads.existingClaim: ""
    asserts:
      - equal:
          path: spec.template.spec.volumes[1].persistentVolumeClaim.claimName
          value: RELEASE-NAME-transmission-downloads
      - isNull:
          path: spec.template.spec.volumes[1].nfs

  - it: should use existingClaim when type is pvc and existingClaim is set
    set:
      persistence.downloads.type: pvc
      persistence.downloads.existingClaim: my-existing-pvc
    asserts:
      - equal:
          path: spec.template.spec.volumes[1].persistentVolumeClaim.claimName
          value: my-existing-pvc
      - isNull:
          path: spec.template.spec.volumes[1].nfs

  # Note: The combination of existingClaim with type: nfs is blocked at the schema level
  # (values.schema.json if/then validation), so no template-level test is needed

  - it: should ignore empty existingClaim with type nfs
    set:
      persistence.downloads.type: nfs
      persistence.downloads.nfsServer: nfs-server.example.com
      persistence.downloads.nfsPath: /mnt/downloads
      persistence.downloads.existingClaim: ""
    asserts:
      - equal:
          path: spec.template.spec.volumes[1].nfs.server
          value: nfs-server.example.com
      - isNull:
          path: spec.template.spec.volumes[1].persistentVolumeClaim

  - it: should ignore empty existingClaim with type pvc
    set:
      persistence.downloads.type: pvc
      persistence.downloads.existingClaim: ""
    asserts:
      - equal:
          path: spec.template.spec.volumes[1].persistentVolumeClaim.claimName
          value: RELEASE-NAME-transmission-downloads
      - isNull:
          path: spec.template.spec.volumes[1].nfs

  # Extra volumes tests
  - it: should not have extra volumes by default
    asserts:
      - lengthEqual:
          path: spec.template.spec.volumes
          count: 2
      - lengthEqual:
          path: spec.template.spec.containers[0].volumeMounts
          count: 2

  - it: should add extra volumes when specified
    set:
      extraVolumes:
        - name: extra-data
          persistentVolumeClaim:
            claimName: my-existing-pvc
        - name: temp-storage
          emptyDir: {}
    asserts:
      - lengthEqual:
          path: spec.template.spec.volumes
          count: 4
      - contains:
          path: spec.template.spec.volumes
          content:
            name: extra-data
            persistentVolumeClaim:
              claimName: my-existing-pvc
      - contains:
          path: spec.template.spec.volumes
          content:
            name: temp-storage
            emptyDir: {}

  - it: should add extra volume mounts when specified
    set:
      extraVolumeMounts:
        - name: extra-data
          mountPath: /extra-data
        - name: temp-storage
          mountPath: /tmp
          readOnly: true
    asserts:
      - lengthEqual:
          path: spec.template.spec.containers[0].volumeMounts
          count: 4
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: extra-data
            mountPath: /extra-data
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: temp-storage
            mountPath: /tmp
            readOnly: true

  - it: should handle extra volumes with subPath
    set:
      extraVolumeMounts:
        - name: shared-volume
          mountPath: /app/data
          subPath: app-data
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: shared-volume
            mountPath: /app/data
            subPath: app-data

  - it: should add both extra volumes and mounts together
    set:
      extraVolumes:
        - name: incomplete
          nfs:
            server: nfs.example.com
            path: /exports/incomplete
      extraVolumeMounts:
        - name: incomplete
          mountPath: /downloads/incomplete
    asserts:
      - lengthEqual:
          path: spec.template.spec.volumes
          count: 3
      - lengthEqual:
          path: spec.template.spec.containers[0].volumeMounts
          count: 3
      - contains:
          path: spec.template.spec.volumes
          content:
            name: incomplete
            nfs:
              server: nfs.example.com
              path: /exports/incomplete
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: incomplete
            mountPath: /downloads/incomplete

  # Extra containers (sidecar) tests
  - it: should not have extra containers by default
    asserts:
      - lengthEqual:
          path: spec.template.spec.containers
          count: 1

  - it: should render extra containers when configured
    set:
      extraContainers:
        - name: sidecar
          image: busybox:latest
          command: ["sh", "-c", "sleep infinity"]
    asserts:
      - lengthEqual:
          path: spec.template.spec.containers
          count: 2
      - equal:
          path: spec.template.spec.containers[1].name
          value: sidecar
      - equal:
          path: spec.template.spec.containers[1].image
          value: busybox:latest

  - it: should work with gluetun VPN sidecar configuration
    set:
      extraContainers:
        - name: gluetun
          image: qmcgaw/gluetun:latest
          securityContext:
            capabilities:
              add:
                - NET_ADMIN
          env:
            - name: VPN_SERVICE_PROVIDER
              value: "custom"
          volumeMounts:
            - name: gluetun-config
              mountPath: /gluetun
      extraVolumes:
        - name: gluetun-config
          secret:
            secretName: gluetun-config
    asserts:
      - lengthEqual:
          path: spec.template.spec.containers
          count: 2
      - equal:
          path: spec.template.spec.containers[1].name
          value: gluetun
      - equal:
          path: spec.template.spec.containers[1].image
          value: qmcgaw/gluetun:latest
      - contains:
          path: spec.template.spec.containers[1].securityContext.capabilities.add
          content: NET_ADMIN
      - contains:
          path: spec.template.spec.containers[1].env
          content:
            name: VPN_SERVICE_PROVIDER
            value: "custom"
      - contains:
          path: spec.template.spec.volumes
          content:
            name: gluetun-config
            secret:
              secretName: gluetun-config
