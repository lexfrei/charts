suite: test statefulset
templates:
  - statefulset.yaml
tests:
  - it: should create StatefulSet
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: StatefulSet
      - equal:
          path: metadata.name
          value: RELEASE-NAME-transmission

  - it: should have single replica
    asserts:
      - equal:
          path: spec.replicas
          value: 1

  - it: should have correct serviceName
    asserts:
      - equal:
          path: spec.serviceName
          value: RELEASE-NAME-transmission

  - it: should use correct image
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^linuxserver/transmission:[0-9]+\.[0-9]+\.[0-9]+$

  - it: should expose all ports
    asserts:
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: http
            containerPort: 9091
            protocol: TCP
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: torrent-tcp
            containerPort: 51413
            protocol: TCP
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: torrent-udp
            containerPort: 51413
            protocol: UDP

  - it: should set environment variables
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: PUID
            value: "1000"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: PGID
            value: "1000"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: TZ
            value: "Europe/Moscow"

  - it: should set security context
    asserts:
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 1000
      - equal:
          path: spec.template.spec.securityContext.seccompProfile.type
          value: RuntimeDefault

  - it: should not have initContainers by default
    asserts:
      - isNull:
          path: spec.template.spec.initContainers

  - it: should render initContainers when specified
    set:
      initContainers:
        - name: init-permissions
          image: busybox:latest
          command: ['sh', '-c', 'echo "Init container running"']
    asserts:
      - isNotNull:
          path: spec.template.spec.initContainers
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: init-permissions
      - equal:
          path: spec.template.spec.initContainers[0].image
          value: busybox:latest

  # Downloads volume tests
  - it: should use NFS volume when type is nfs
    set:
      persistence.downloads.type: nfs
      persistence.downloads.nfsServer: my-nfs-server.local
      persistence.downloads.nfsPath: /exports/downloads
      persistence.downloads.existingClaim: ""
    asserts:
      - equal:
          path: spec.template.spec.volumes[1].nfs.server
          value: my-nfs-server.local
      - equal:
          path: spec.template.spec.volumes[1].nfs.path
          value: /exports/downloads
      - isNull:
          path: spec.template.spec.volumes[1].persistentVolumeClaim

  - it: should use default PVC when type is pvc without existingClaim
    set:
      persistence.downloads.type: pvc
      persistence.downloads.existingClaim: ""
    asserts:
      - equal:
          path: spec.template.spec.volumes[1].persistentVolumeClaim.claimName
          value: RELEASE-NAME-transmission-downloads
      - isNull:
          path: spec.template.spec.volumes[1].nfs

  - it: should use existingClaim when type is pvc and existingClaim is set
    set:
      persistence.downloads.type: pvc
      persistence.downloads.existingClaim: my-existing-pvc
    asserts:
      - equal:
          path: spec.template.spec.volumes[1].persistentVolumeClaim.claimName
          value: my-existing-pvc
      - isNull:
          path: spec.template.spec.volumes[1].nfs

  # Note: The combination of existingClaim with type: nfs is blocked at the schema level
  # (values.schema.json if/then validation), so no template-level test is needed

  - it: should ignore empty existingClaim with type nfs
    set:
      persistence.downloads.type: nfs
      persistence.downloads.nfsServer: nfs-server.example.com
      persistence.downloads.nfsPath: /mnt/downloads
      persistence.downloads.existingClaim: ""
    asserts:
      - equal:
          path: spec.template.spec.volumes[1].nfs.server
          value: nfs-server.example.com
      - isNull:
          path: spec.template.spec.volumes[1].persistentVolumeClaim

  - it: should ignore empty existingClaim with type pvc
    set:
      persistence.downloads.type: pvc
      persistence.downloads.existingClaim: ""
    asserts:
      - equal:
          path: spec.template.spec.volumes[1].persistentVolumeClaim.claimName
          value: RELEASE-NAME-transmission-downloads
      - isNull:
          path: spec.template.spec.volumes[1].nfs

  # Extra volumes tests
  - it: should not have extra volumes by default
    asserts:
      - lengthEqual:
          path: spec.template.spec.volumes
          count: 2
      - lengthEqual:
          path: spec.template.spec.containers[0].volumeMounts
          count: 2

  - it: should add extra volumes when specified
    set:
      extraVolumes:
        - name: extra-data
          persistentVolumeClaim:
            claimName: my-existing-pvc
        - name: temp-storage
          emptyDir: {}
    asserts:
      - lengthEqual:
          path: spec.template.spec.volumes
          count: 4
      - contains:
          path: spec.template.spec.volumes
          content:
            name: extra-data
            persistentVolumeClaim:
              claimName: my-existing-pvc
      - contains:
          path: spec.template.spec.volumes
          content:
            name: temp-storage
            emptyDir: {}

  - it: should add extra volume mounts when specified
    set:
      extraVolumeMounts:
        - name: extra-data
          mountPath: /extra-data
        - name: temp-storage
          mountPath: /tmp
          readOnly: true
    asserts:
      - lengthEqual:
          path: spec.template.spec.containers[0].volumeMounts
          count: 4
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: extra-data
            mountPath: /extra-data
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: temp-storage
            mountPath: /tmp
            readOnly: true

  - it: should handle extra volumes with subPath
    set:
      extraVolumeMounts:
        - name: shared-volume
          mountPath: /app/data
          subPath: app-data
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: shared-volume
            mountPath: /app/data
            subPath: app-data

  - it: should add both extra volumes and mounts together
    set:
      extraVolumes:
        - name: incomplete
          nfs:
            server: nfs.example.com
            path: /exports/incomplete
      extraVolumeMounts:
        - name: incomplete
          mountPath: /downloads/incomplete
    asserts:
      - lengthEqual:
          path: spec.template.spec.volumes
          count: 3
      - lengthEqual:
          path: spec.template.spec.containers[0].volumeMounts
          count: 3
      - contains:
          path: spec.template.spec.volumes
          content:
            name: incomplete
            nfs:
              server: nfs.example.com
              path: /exports/incomplete
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: incomplete
            mountPath: /downloads/incomplete
