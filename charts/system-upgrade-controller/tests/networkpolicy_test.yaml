suite: test networkpolicy
templates:
  - networkpolicy.yaml
tests:
  # Basic NetworkPolicy tests
  - it: should not create NetworkPolicy by default
    asserts:
      - hasDocuments:
          count: 0

  - it: should create NetworkPolicy when enabled
    set:
      networkPolicy.enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: NetworkPolicy
      - equal:
          path: apiVersion
          value: networking.k8s.io/v1

  # Metadata tests
  - it: should have correct name and labels
    set:
      networkPolicy.enabled: true
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-system-upgrade-controller
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: system-upgrade-controller

  # Pod selector tests
  - it: should select pods with correct labels
    set:
      networkPolicy.enabled: true
    asserts:
      - equal:
          path: spec.podSelector.matchLabels["app.kubernetes.io/name"]
          value: system-upgrade-controller
      - equal:
          path: spec.podSelector.matchLabels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  # Policy types tests
  - it: should include both Ingress and Egress policy types
    set:
      networkPolicy.enabled: true
    asserts:
      - contains:
          path: spec.policyTypes
          content: Ingress
      - contains:
          path: spec.policyTypes
          content: Egress

  # Ingress rules tests
  - it: should have empty ingress rules by default
    set:
      networkPolicy.enabled: true
    asserts:
      - lengthEqual:
          path: spec.ingress
          count: 0

  - it: should add custom ingress rules
    set:
      networkPolicy:
        enabled: true
        ingress:
          - from:
              - podSelector:
                  matchLabels:
                    app: monitoring
            ports:
              - protocol: TCP
                port: 8080
    asserts:
      - lengthEqual:
          path: spec.ingress
          count: 1
      - equal:
          path: spec.ingress[0].from[0].podSelector.matchLabels.app
          value: monitoring
      - equal:
          path: spec.ingress[0].ports[0].port
          value: 8080

  - it: should support multiple ingress rules
    set:
      networkPolicy:
        enabled: true
        ingress:
          - from:
              - podSelector:
                  matchLabels:
                    app: prometheus
          - from:
              - namespaceSelector:
                  matchLabels:
                    name: monitoring
    asserts:
      - lengthEqual:
          path: spec.ingress
          count: 2

  - it: should support ingress from specific namespaces
    set:
      networkPolicy:
        enabled: true
        ingress:
          - from:
              - namespaceSelector:
                  matchLabels:
                    kubernetes.io/metadata.name: kube-system
    asserts:
      - equal:
          path: spec.ingress[0].from[0].namespaceSelector.matchLabels["kubernetes.io/metadata.name"]
          value: kube-system

  - it: should support ingress from specific IPs
    set:
      networkPolicy:
        enabled: true
        ingress:
          - from:
              - ipBlock:
                  cidr: 10.0.0.0/8
                  except:
                    - 10.1.0.0/16
    asserts:
      - equal:
          path: spec.ingress[0].from[0].ipBlock.cidr
          value: 10.0.0.0/8
      - contains:
          path: spec.ingress[0].from[0].ipBlock.except
          content: 10.1.0.0/16

  # Egress rules tests
  - it: should have default egress rules for Kubernetes API and DNS
    set:
      networkPolicy.enabled: true
    asserts:
      - lengthEqual:
          path: spec.egress
          count: 2

  - it: should allow DNS egress
    set:
      networkPolicy.enabled: true
    asserts:
      - contains:
          path: spec.egress[0].ports
          content:
            protocol: UDP
            port: 53

  - it: should allow Kubernetes API egress
    set:
      networkPolicy.enabled: true
    asserts:
      - contains:
          path: spec.egress[1].ports
          content:
            protocol: TCP
            port: 443
      - equal:
          path: spec.egress[1].to[0].namespaceSelector
          value: {}

  - it: should add custom egress rules
    set:
      networkPolicy:
        enabled: true
        egress:
          - to:
              - podSelector:
                  matchLabels:
                    app: image-registry
            ports:
              - protocol: TCP
                port: 5000
    asserts:
      - lengthEqual:
          path: spec.egress
          count: 3
      - equal:
          path: spec.egress[2].to[0].podSelector.matchLabels.app
          value: image-registry

  - it: should support multiple custom egress rules
    set:
      networkPolicy:
        enabled: true
        egress:
          - to:
              - podSelector:
                  matchLabels:
                    app: registry
          - to:
              - podSelector:
                  matchLabels:
                    app: mirror
    asserts:
      - lengthEqual:
          path: spec.egress
          count: 4

  - it: should support egress to external container registries
    set:
      networkPolicy:
        enabled: true
        egress:
          - to:
              - ipBlock:
                  cidr: 0.0.0.0/0
                  except:
                    - 169.254.169.254/32
                    - 10.0.0.0/8
            ports:
              - protocol: TCP
                port: 443
    asserts:
      - equal:
          path: spec.egress[2].to[0].ipBlock.cidr
          value: 0.0.0.0/0
      - contains:
          path: spec.egress[2].to[0].ipBlock.except
          content: 169.254.169.254/32

  # Edge cases
  - it: should handle empty ingress array
    set:
      networkPolicy:
        enabled: true
        ingress: []
    asserts:
      - lengthEqual:
          path: spec.ingress
          count: 0

  - it: should handle empty egress array but keep defaults
    set:
      networkPolicy:
        enabled: true
        egress: []
    asserts:
      - lengthEqual:
          path: spec.egress
          count: 2

  - it: should support complex port definitions
    set:
      networkPolicy:
        enabled: true
        ingress:
          - ports:
              - protocol: TCP
                port: 8080
              - protocol: TCP
                port: 9090
              - protocol: TCP
                port: 10250
    asserts:
      - lengthEqual:
          path: spec.ingress[0].ports
          count: 3

  - it: should support multiple sources in single rule
    set:
      networkPolicy:
        enabled: true
        ingress:
          - from:
              - podSelector:
                  matchLabels:
                    role: node
              - namespaceSelector:
                  matchLabels:
                    name: kube-system
              - ipBlock:
                  cidr: 192.168.0.0/16
    asserts:
      - lengthEqual:
          path: spec.ingress[0].from
          count: 3

  - it: should support egress to multiple namespaces
    set:
      networkPolicy:
        enabled: true
        egress:
          - to:
              - namespaceSelector:
                  matchLabels:
                    name: kube-system
          - to:
              - namespaceSelector:
                  matchLabels:
                    name: cattle-system
    asserts:
      - lengthEqual:
          path: spec.egress
          count: 4

  - it: should respect fullnameOverride
    set:
      fullnameOverride: custom-controller
      networkPolicy.enabled: true
    asserts:
      - equal:
          path: metadata.name
          value: custom-controller

  - it: should respect nameOverride in labels
    set:
      nameOverride: custom
      networkPolicy.enabled: true
    asserts:
      - matchRegex:
          path: spec.podSelector.matchLabels["app.kubernetes.io/name"]
          pattern: custom

  # Kubernetes API access edge cases
  - it: should allow HTTPS traffic to API server
    set:
      networkPolicy.enabled: true
    asserts:
      - contains:
          path: spec.egress[1].ports
          content:
            protocol: TCP
            port: 443

  - it: should support additional API server ports
    set:
      networkPolicy:
        enabled: true
        egress:
          - to:
              - namespaceSelector:
                  matchLabels:
                    kubernetes.io/metadata.name: default
            ports:
              - protocol: TCP
                port: 6443
              - protocol: TCP
                port: 443
    asserts:
      - lengthEqual:
          path: spec.egress[2].ports
          count: 2
