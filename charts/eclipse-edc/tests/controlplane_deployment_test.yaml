suite: test control plane deployment
templates:
  - controlplane/deployment.yaml
  - controlplane/configmap.yaml
tests:
  - it: should create deployment when controlPlane is enabled
    set:
      controlPlane:
        enabled: true
    asserts:
      - template: controlplane/deployment.yaml
        isKind:
          of: Deployment
      - template: controlplane/deployment.yaml
        equal:
          path: metadata.name
          value: RELEASE-NAME-eclipse-edc-controlplane

  - it: should NOT create deployment when controlPlane is disabled
    set:
      controlPlane:
        enabled: false
    asserts:
      - template: controlplane/deployment.yaml
        hasDocuments:
          count: 0

  - it: should use correct image with default tag
    set:
      controlPlane:
        enabled: true
    asserts:
      - template: controlplane/deployment.yaml
        matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^eclipseedc/edc-controlplane:.+$

  - it: should use custom image tag when specified
    set:
      controlPlane:
        enabled: true
        image:
          tag: "custom-tag"
    asserts:
      - template: controlplane/deployment.yaml
        equal:
          path: spec.template.spec.containers[0].image
          value: "eclipseedc/edc-controlplane:custom-tag"

  - it: should set replica count
    set:
      controlPlane:
        enabled: true
        replicaCount: 3
    asserts:
      - template: controlplane/deployment.yaml
        equal:
          path: spec.replicas
          value: 3

  - it: should set pod security context
    set:
      controlPlane:
        enabled: true
    asserts:
      - template: controlplane/deployment.yaml
        equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true
      - template: controlplane/deployment.yaml
        equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 65532

  - it: should set container security context
    set:
      controlPlane:
        enabled: true
    asserts:
      - template: controlplane/deployment.yaml
        equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false
      - template: controlplane/deployment.yaml
        equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true
      - template: controlplane/deployment.yaml
        contains:
          path: spec.template.spec.containers[0].securityContext.capabilities.drop
          content: ALL

  - it: should expose correct ports
    set:
      controlPlane:
        enabled: true
    asserts:
      - template: controlplane/deployment.yaml
        contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: management
            containerPort: 8181
            protocol: TCP
      - template: controlplane/deployment.yaml
        contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: protocol
            containerPort: 8182
            protocol: TCP
      - template: controlplane/deployment.yaml
        contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: default
            containerPort: 8282
            protocol: TCP

  - it: should use custom ports when specified
    set:
      controlPlane:
        enabled: true
        ports:
          management: 9181
          protocol: 9182
          default: 9282
    asserts:
      - template: controlplane/deployment.yaml
        contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: management
            containerPort: 9181
            protocol: TCP

  - it: should set resource limits when specified
    set:
      controlPlane:
        enabled: true
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 250m
            memory: 256Mi
    asserts:
      - template: controlplane/deployment.yaml
        equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 500m
      - template: controlplane/deployment.yaml
        equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 512Mi

  - it: should add pod annotations when specified
    set:
      controlPlane:
        enabled: true
        podAnnotations:
          custom-annotation: "value"
    asserts:
      - template: controlplane/deployment.yaml
        equal:
          path: spec.template.metadata.annotations["custom-annotation"]
          value: "value"

  - it: should add pod labels when specified
    set:
      controlPlane:
        enabled: true
        podLabels:
          custom-label: "value"
    asserts:
      - template: controlplane/deployment.yaml
        equal:
          path: spec.template.metadata.labels["custom-label"]
          value: "value"

  - it: should have component label
    set:
      controlPlane:
        enabled: true
    asserts:
      - template: controlplane/deployment.yaml
        equal:
          path: spec.template.metadata.labels["app.kubernetes.io/component"]
          value: controlplane

  - it: should mount config volume
    set:
      controlPlane:
        enabled: true
    asserts:
      - template: controlplane/deployment.yaml
        contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: config
            mountPath: /app/config
            readOnly: true

  - it: should reference service account
    set:
      controlPlane:
        enabled: true
        serviceAccount:
          create: true
    asserts:
      - template: controlplane/deployment.yaml
        equal:
          path: spec.template.spec.serviceAccountName
          value: RELEASE-NAME-eclipse-edc-controlplane
