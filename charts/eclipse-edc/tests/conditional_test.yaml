suite: test conditional rendering
templates:
  - controlplane/deployment.yaml
  - controlplane/service.yaml
  - controlplane/serviceaccount.yaml
  - controlplane/configmap.yaml
  - dataplane/deployment.yaml
  - dataplane/service.yaml
  - dataplane/serviceaccount.yaml
  - dataplane/configmap.yaml
tests:
  - it: should create only control plane resources when data plane is disabled
    set:
      controlPlane:
        enabled: true
        serviceAccount:
          create: true
      dataPlane:
        enabled: false
    asserts:
      - template: controlplane/deployment.yaml
        isKind:
          of: Deployment
      - template: controlplane/service.yaml
        isKind:
          of: Service
      - template: controlplane/serviceaccount.yaml
        isKind:
          of: ServiceAccount
      - template: controlplane/configmap.yaml
        isKind:
          of: ConfigMap
      - template: dataplane/deployment.yaml
        hasDocuments:
          count: 0
      - template: dataplane/service.yaml
        hasDocuments:
          count: 0
      - template: dataplane/serviceaccount.yaml
        hasDocuments:
          count: 0
      - template: dataplane/configmap.yaml
        hasDocuments:
          count: 0

  - it: should create only data plane resources when control plane is disabled
    set:
      controlPlane:
        enabled: false
      dataPlane:
        enabled: true
        serviceAccount:
          create: true
    asserts:
      - template: controlplane/deployment.yaml
        hasDocuments:
          count: 0
      - template: controlplane/service.yaml
        hasDocuments:
          count: 0
      - template: controlplane/serviceaccount.yaml
        hasDocuments:
          count: 0
      - template: controlplane/configmap.yaml
        hasDocuments:
          count: 0
      - template: dataplane/deployment.yaml
        isKind:
          of: Deployment
      - template: dataplane/service.yaml
        isKind:
          of: Service
      - template: dataplane/serviceaccount.yaml
        isKind:
          of: ServiceAccount
      - template: dataplane/configmap.yaml
        isKind:
          of: ConfigMap

  - it: should create both when both are enabled
    set:
      controlPlane:
        enabled: true
        serviceAccount:
          create: true
      dataPlane:
        enabled: true
        serviceAccount:
          create: true
    asserts:
      - template: controlplane/deployment.yaml
        isKind:
          of: Deployment
      - template: dataplane/deployment.yaml
        isKind:
          of: Deployment

  - it: should create no plane resources when both are disabled
    set:
      controlPlane:
        enabled: false
      dataPlane:
        enabled: false
    asserts:
      - template: controlplane/deployment.yaml
        hasDocuments:
          count: 0
      - template: controlplane/service.yaml
        hasDocuments:
          count: 0
      - template: dataplane/deployment.yaml
        hasDocuments:
          count: 0
      - template: dataplane/service.yaml
        hasDocuments:
          count: 0
