suite: serviceaccount tests
templates:
  - templates/serviceaccount.yaml
set:
  connector.config.participantId: "test-participant"
tests:
  - it: should create ServiceAccount by default
    asserts:
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: RELEASE-NAME-eclipse-edc

  - it: should not create ServiceAccount when disabled
    set:
      connector.serviceAccount.create: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should disable automount by default
    asserts:
      - equal:
          path: automountServiceAccountToken
          value: false

  - it: should add annotations when specified
    set:
      connector.serviceAccount.annotations:
        eks.amazonaws.com/role-arn: arn:aws:iam::123456789:role/edc-role
    asserts:
      - equal:
          path: metadata.annotations
          value:
            eks.amazonaws.com/role-arn: arn:aws:iam::123456789:role/edc-role

  - it: should have standard labels
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: eclipse-edc
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
      - isNotNull:
          path: metadata.labels["helm.sh/chart"]
