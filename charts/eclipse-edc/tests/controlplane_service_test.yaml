suite: test control plane service
templates:
  - controlplane/service.yaml
tests:
  - it: should create service when controlPlane is enabled
    set:
      controlPlane:
        enabled: true
    asserts:
      - isKind:
          of: Service
      - equal:
          path: metadata.name
          value: RELEASE-NAME-eclipse-edc-controlplane

  - it: should NOT create service when controlPlane is disabled
    set:
      controlPlane:
        enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should use ClusterIP type by default
    set:
      controlPlane:
        enabled: true
    asserts:
      - equal:
          path: spec.type
          value: ClusterIP

  - it: should use custom service type when specified
    set:
      controlPlane:
        enabled: true
        service:
          type: LoadBalancer
    asserts:
      - equal:
          path: spec.type
          value: LoadBalancer

  - it: should expose correct ports
    set:
      controlPlane:
        enabled: true
    asserts:
      - contains:
          path: spec.ports
          content:
            port: 8181
            targetPort: management
            protocol: TCP
            name: management
      - contains:
          path: spec.ports
          content:
            port: 8182
            targetPort: protocol
            protocol: TCP
            name: protocol
      - contains:
          path: spec.ports
          content:
            port: 8282
            targetPort: default
            protocol: TCP
            name: default

  - it: should use custom ports when specified
    set:
      controlPlane:
        enabled: true
        ports:
          management: 9181
          protocol: 9182
          default: 9282
    asserts:
      - contains:
          path: spec.ports
          content:
            port: 9181
            targetPort: management
            protocol: TCP
            name: management

  - it: should add service annotations when specified
    set:
      controlPlane:
        enabled: true
        service:
          annotations:
            custom-annotation: "value"
    asserts:
      - equal:
          path: metadata.annotations["custom-annotation"]
          value: "value"

  - it: should have correct selector labels
    set:
      controlPlane:
        enabled: true
    asserts:
      - equal:
          path: spec.selector["app.kubernetes.io/component"]
          value: controlplane
      - equal:
          path: spec.selector["app.kubernetes.io/name"]
          value: eclipse-edc
