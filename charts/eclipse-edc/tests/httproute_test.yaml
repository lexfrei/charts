suite: httproute tests
templates:
  - templates/httproute.yaml
set:
  connector.config.participantId: "test-participant"
tests:
  - it: should not create HTTPRoute by default
    asserts:
      - hasDocuments:
          count: 0

  - it: should create HTTPRoute when enabled
    set:
      httpRoute.enabled: true
      httpRoute.hostnames:
        - edc.example.com
      httpRoute.rules:
        - matches:
            - path:
                type: PathPrefix
                value: /protocol
          port: 8183
    asserts:
      - isKind:
          of: HTTPRoute
      - equal:
          path: metadata.name
          value: RELEASE-NAME-eclipse-edc

  - it: should set correct apiVersion
    set:
      httpRoute.enabled: true
      httpRoute.hostnames:
        - edc.example.com
      httpRoute.rules:
        - matches:
            - path:
                type: PathPrefix
                value: /
          port: 8181
    asserts:
      - equal:
          path: apiVersion
          value: gateway.networking.k8s.io/v1

  - it: should configure parent refs
    set:
      httpRoute.enabled: true
      httpRoute.parentRefs:
        - name: my-gateway
          namespace: gateway-ns
      httpRoute.hostnames:
        - edc.example.com
      httpRoute.rules:
        - matches:
            - path:
                type: PathPrefix
                value: /
          port: 8181
    asserts:
      - equal:
          path: spec.parentRefs[0].name
          value: my-gateway
      - equal:
          path: spec.parentRefs[0].namespace
          value: gateway-ns

  - it: should configure hostnames
    set:
      httpRoute.enabled: true
      httpRoute.hostnames:
        - edc.example.com
        - edc2.example.com
      httpRoute.rules:
        - matches:
            - path:
                type: PathPrefix
                value: /
          port: 8181
    asserts:
      - contains:
          path: spec.hostnames
          content: edc.example.com
      - contains:
          path: spec.hostnames
          content: edc2.example.com

  - it: should configure path matching rule
    set:
      httpRoute.enabled: true
      httpRoute.hostnames:
        - edc.example.com
      httpRoute.rules:
        - matches:
            - path:
                type: PathPrefix
                value: /protocol
          port: 8183
    asserts:
      - equal:
          path: spec.rules[0].matches[0].path.type
          value: PathPrefix
      - equal:
          path: spec.rules[0].matches[0].path.value
          value: /protocol

  - it: should route to correct service port
    set:
      httpRoute.enabled: true
      httpRoute.hostnames:
        - edc.example.com
      httpRoute.rules:
        - matches:
            - path:
                type: PathPrefix
                value: /protocol
          port: 8183
    asserts:
      - equal:
          path: spec.rules[0].backendRefs[0].name
          value: RELEASE-NAME-eclipse-edc
      - equal:
          path: spec.rules[0].backendRefs[0].port
          value: 8183

  - it: should support multiple rules for different endpoints
    set:
      httpRoute.enabled: true
      httpRoute.hostnames:
        - edc.example.com
      httpRoute.rules:
        - matches:
            - path:
                type: PathPrefix
                value: /protocol
          port: 8183
        - matches:
            - path:
                type: PathPrefix
                value: /public
          port: 8184
        - matches:
            - path:
                type: PathPrefix
                value: /management
          port: 8182
    asserts:
      - lengthEqual:
          path: spec.rules
          count: 3
      - equal:
          path: spec.rules[0].backendRefs[0].port
          value: 8183
      - equal:
          path: spec.rules[1].backendRefs[0].port
          value: 8184
      - equal:
          path: spec.rules[2].backendRefs[0].port
          value: 8182

  - it: should add annotations when specified
    set:
      httpRoute.enabled: true
      httpRoute.annotations:
        custom-annotation: custom-value
      httpRoute.hostnames:
        - edc.example.com
      httpRoute.rules:
        - matches:
            - path:
                type: PathPrefix
                value: /
          port: 8181
    asserts:
      - equal:
          path: metadata.annotations
          value:
            custom-annotation: custom-value

  - it: should have standard labels
    set:
      httpRoute.enabled: true
      httpRoute.hostnames:
        - edc.example.com
      httpRoute.rules:
        - matches:
            - path:
                type: PathPrefix
                value: /
          port: 8181
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: eclipse-edc
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  - it: should support traffic weight
    set:
      httpRoute.enabled: true
      httpRoute.hostnames:
        - edc.example.com
      httpRoute.rules:
        - matches:
            - path:
                type: PathPrefix
                value: /
          port: 8181
          weight: 100
    asserts:
      - equal:
          path: spec.rules[0].backendRefs[0].weight
          value: 100
