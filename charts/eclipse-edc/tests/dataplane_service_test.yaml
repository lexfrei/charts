suite: test data plane service
templates:
  - dataplane/service.yaml
tests:
  - it: should create service when dataPlane is enabled
    set:
      dataPlane:
        enabled: true
    asserts:
      - isKind:
          of: Service
      - equal:
          path: metadata.name
          value: RELEASE-NAME-eclipse-edc-dataplane

  - it: should NOT create service when dataPlane is disabled
    set:
      dataPlane:
        enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should use ClusterIP type by default
    set:
      dataPlane:
        enabled: true
    asserts:
      - equal:
          path: spec.type
          value: ClusterIP

  - it: should use custom service type when specified
    set:
      dataPlane:
        enabled: true
        service:
          type: LoadBalancer
    asserts:
      - equal:
          path: spec.type
          value: LoadBalancer

  - it: should expose correct ports
    set:
      dataPlane:
        enabled: true
    asserts:
      - contains:
          path: spec.ports
          content:
            port: 8185
            targetPort: public
            protocol: TCP
            name: public
      - contains:
          path: spec.ports
          content:
            port: 8186
            targetPort: control
            protocol: TCP
            name: control

  - it: should use custom ports when specified
    set:
      dataPlane:
        enabled: true
        ports:
          public: 9185
          control: 9186
    asserts:
      - contains:
          path: spec.ports
          content:
            port: 9185
            targetPort: public
            protocol: TCP
            name: public

  - it: should add service annotations when specified
    set:
      dataPlane:
        enabled: true
        service:
          annotations:
            custom-annotation: "value"
    asserts:
      - equal:
          path: metadata.annotations["custom-annotation"]
          value: "value"

  - it: should have correct selector labels
    set:
      dataPlane:
        enabled: true
    asserts:
      - equal:
          path: spec.selector["app.kubernetes.io/component"]
          value: dataplane
      - equal:
          path: spec.selector["app.kubernetes.io/name"]
          value: eclipse-edc
