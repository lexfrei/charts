suite: test rbac
templates:
  - serviceaccount.yaml
  - clusterrole.yaml
  - clusterrolebinding.yaml
tests:
  - it: should create ServiceAccount by default
    template: serviceaccount.yaml
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: RELEASE-NAME-extractedprism

  - it: should not create ServiceAccount when disabled
    template: serviceaccount.yaml
    set:
      serviceAccount:
        create: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should support custom ServiceAccount name
    template: serviceaccount.yaml
    set:
      serviceAccount:
        create: true
        name: custom-sa
    asserts:
      - equal:
          path: metadata.name
          value: custom-sa

  - it: should support ServiceAccount annotations
    template: serviceaccount.yaml
    set:
      serviceAccount:
        create: true
        annotations:
          eks.amazonaws.com/role-arn: arn:aws:iam::role/test
    asserts:
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: "arn:aws:iam::role/test"

  - it: should create ClusterRole with endpoint discovery permissions
    template: clusterrole.yaml
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ClusterRole
      - contains:
          path: rules
          content:
            apiGroups:
              - discovery.k8s.io
            resources:
              - endpointslices
            verbs:
              - get
              - list
              - watch

  - it: should create ClusterRoleBinding
    template: clusterrolebinding.yaml
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ClusterRoleBinding
      - equal:
          path: roleRef.kind
          value: ClusterRole
      - equal:
          path: subjects[0].kind
          value: ServiceAccount
      - equal:
          path: subjects[0].name
          value: RELEASE-NAME-extractedprism
