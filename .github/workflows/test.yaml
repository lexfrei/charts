name: Lint and Test Charts

on:
  pull_request:
    # Run on all PRs to validate charts and workflow changes
  push:
    # Run only on pushes to master to validate after merge
    branches:
      - master
  workflow_dispatch:
    inputs:
      charts:
        description: 'JSON array of chart paths to test (optional)'
        required: false
        type: string
  repository_dispatch:
    types:
      - test-charts

jobs:
  create-pending-statuses:
    # Only run for repository_dispatch events to create commit statuses
    if: github.event_name == 'repository_dispatch'
    runs-on: ubuntu-latest
    permissions:
      statuses: write
    strategy:
      matrix:
        chart:
          - charts/cloudflare-tunnel
          - charts/me-site
          - charts/system-upgrade-controller
          - charts/transmission
          - charts/vipalived
    steps:
      - name: Create pending status
        run: |
          CONTEXT="lint-test (${{ matrix.chart }})"
          SHA="${{ github.event.client_payload.sha }}"

          echo "Creating pending status for $CONTEXT on commit $SHA"

          gh api repos/${{ github.repository }}/statuses/$SHA \
            --method POST \
            --field state=pending \
            --field context="$CONTEXT" \
            --field description="Running tests..." \
            --field target_url="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  lint-test:
    runs-on: ubuntu-latest
    needs: [create-pending-statuses]
    if: always() && (needs.create-pending-statuses.result == 'success' || needs.create-pending-statuses.result == 'skipped')
    permissions:
      contents: read
      statuses: write
    strategy:
      matrix:
        chart:
          - charts/cloudflare-tunnel
          - charts/me-site
          - charts/system-upgrade-controller
          - charts/transmission
          - charts/vipalived
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.8.0

      - name: Install tools
        run: |
          # helm-unittest
          helm plugin install https://github.com/helm-unittest/helm-unittest.git

          # JSON schema validator
          pip install check-jsonschema

          # Artifact Hub CLI
          # renovate: datasource=github-releases depName=artifacthub/hub
          AH_VERSION="1.21.0"
          wget -q https://github.com/artifacthub/hub/releases/download/v${AH_VERSION}/ah_${AH_VERSION}_linux_amd64.tar.gz
          tar -xzf ah_${AH_VERSION}_linux_amd64.tar.gz
          chmod +x ah
          sudo mv ah /usr/local/bin/ah

          # helm-docs
          # renovate: datasource=github-releases depName=norwoodj/helm-docs
          HELM_DOCS_VERSION="1.14.2"
          wget -q https://github.com/norwoodj/helm-docs/releases/download/v${HELM_DOCS_VERSION}/helm-docs_${HELM_DOCS_VERSION}_Linux_x86_64.tar.gz
          tar -xzf helm-docs_${HELM_DOCS_VERSION}_Linux_x86_64.tar.gz
          chmod +x helm-docs
          sudo mv helm-docs /usr/local/bin/helm-docs

          # markdownlint-cli
          npm install -g markdownlint-cli

      # Chain 1: Helm validation -> Unit tests -> Advanced linting
      - name: Run Helm Lint
        run: |
          echo "üîç Running Helm lint..."
          helm lint ${{ matrix.chart }}

      - name: Run Helm Unittest
        run: |
          CHART_DIR="${{ matrix.chart }}"
          if [ -d "$CHART_DIR/tests" ]; then
            echo "üß™ Running unit tests..."
            helm unittest $CHART_DIR --color --with-subchart=false
          else
            echo "‚ÑπÔ∏è  No tests directory found, skipping unit tests"
          fi

      - name: Run chart-testing (lint)
        run: |
          echo "üìã Running chart-testing lint..."
          ct lint --charts ${{ matrix.chart }}

      - name: Run Artifact Hub Lint
        run: |
          echo "üèõÔ∏è  Running Artifact Hub lint..."
          ah lint --kind helm --path "${{ matrix.chart }}"

      # Chain 2: Schema validation -> README validation -> Markdown lint
      - name: Validate values.schema.json
        run: |
          CHART_DIR="${{ matrix.chart }}"
          SCHEMA_FILE="$CHART_DIR/values.schema.json"
          VALUES_FILE="$CHART_DIR/values.yaml"

          if [ -f "$SCHEMA_FILE" ]; then
            echo "üìê Validating values.yaml against schema..."
            check-jsonschema --schemafile "$SCHEMA_FILE" "$VALUES_FILE"
          else
            echo "‚ÑπÔ∏è  No schema file found, skipping schema validation"
          fi

      - name: Check README is up to date (helm-docs)
        run: |
          CHART_DIR="${{ matrix.chart }}"

          if [ -f "$CHART_DIR/README.md.gotmpl" ]; then
            echo "üìö Checking if README.md is up to date..."
            helm-docs "$CHART_DIR"

            if git diff --exit-code "$CHART_DIR/README.md" > /dev/null 2>&1; then
              echo "‚úÖ README.md is up to date!"
            else
              echo ""
              echo "‚ùå ERROR: README.md is out of date!"
              echo ""
              echo "To fix, run: helm-docs charts/$(basename $CHART_DIR)"
              echo ""
              git diff "$CHART_DIR/README.md"
              exit 1
            fi
          else
            echo "‚ÑπÔ∏è  No README.md.gotmpl found, skipping"
          fi

      - name: Run Markdown Lint
        run: |
          CHART_DIR="${{ matrix.chart }}"
          if [ -f "$CHART_DIR/README.md" ]; then
            echo "üìù Linting README.md..."
            markdownlint "$CHART_DIR/README.md"
          else
            echo "‚ÑπÔ∏è  No README.md found, skipping"
          fi

      - name: Update commit status on success
        if: success() && github.event_name == 'repository_dispatch'
        run: |
          CONTEXT="lint-test (${{ matrix.chart }})"
          SHA="${{ github.event.client_payload.sha }}"

          echo "‚úÖ Updating status for $CONTEXT on commit $SHA to success"

          gh api repos/${{ github.repository }}/statuses/$SHA \
            --method POST \
            --field state=success \
            --field context="$CONTEXT" \
            --field description="All checks passed" \
            --field target_url="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update commit status on failure
        if: failure() && github.event_name == 'repository_dispatch'
        run: |
          CONTEXT="lint-test (${{ matrix.chart }})"
          SHA="${{ github.event.client_payload.sha }}"

          echo "‚ùå Updating status for $CONTEXT on commit $SHA to failure"

          gh api repos/${{ github.repository }}/statuses/$SHA \
            --method POST \
            --field state=failure \
            --field context="$CONTEXT" \
            --field description="Some checks failed" \
            --field target_url="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
