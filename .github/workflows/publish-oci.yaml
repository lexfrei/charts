name: Publish Charts to OCI

on:
  push:
    branches:
      - master
    paths:
      - 'charts/**'
      - '!charts/.deploy/**'
  workflow_dispatch:
    inputs:
      charts:
        description: 'JSON array of chart paths to publish (optional)'
        required: false
        type: string

permissions:
  contents: write      # Create releases
  packages: write      # Push to GHCR
  id-token: write      # Keyless signing with OIDC

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      charts: ${{ steps.detect.outputs.charts }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install yq
        run: |
          # renovate: datasource=github-releases depName=mikefarah/yq
          YQ_VERSION="4.44.3"
          wget -q https://github.com/mikefarah/yq/releases/download/v${YQ_VERSION}/yq_linux_amd64 -O yq
          chmod +x yq
          sudo mv yq /usr/local/bin/yq
          yq --version

      - name: Detect charts to publish
        id: detect
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.charts }}" ]]; then
            # Manual override: use provided charts list
            charts_input='${{ inputs.charts }}'
            echo "📋 Manual override with charts: $charts_input"

            if charts_json=$(echo "$charts_input" | jq -c '.' 2>/dev/null); then
              echo "charts=$charts_json" >> "$GITHUB_OUTPUT"
              echo "Using manually provided charts: $charts_json"
            else
              echo "charts=[]" >> "$GITHUB_OUTPUT"
              echo "❌ Invalid JSON provided: $charts_input"
            fi
          else
            # Auto-detect: check all charts for unpublished versions
            echo "🔍 Checking all charts for unpublished versions..."
            charts_to_publish=()

            for chart_dir in charts/*/; do
              chart_name=$(basename "$chart_dir")
              chart_version=$(yq eval '.version' "${chart_dir}Chart.yaml")
              release_tag="${chart_name}-${chart_version}"

              # Check if this version already exists as a release
              if gh release view "$release_tag" >/dev/null 2>&1; then
                echo "  ⏭️  $chart_name:$chart_version already released"
              else
                echo "  📦 $chart_name:$chart_version needs publishing"
                charts_to_publish+=("$chart_dir")
              fi
            done

            # Convert to JSON array
            if [ ${#charts_to_publish[@]} -eq 0 ]; then
              echo "charts=[]" >> "$GITHUB_OUTPUT"
              echo "✅ All charts are up to date"
            else
              charts_json=$(printf '%s\n' "${charts_to_publish[@]}" | jq -R -s -c 'split("\n") | map(select(length > 0))')
              echo "charts=$charts_json" >> "$GITHUB_OUTPUT"
              echo "📦 Will publish: $charts_json"
            fi
          fi

  publish:
    needs: detect-changes
    if: needs.detect-changes.outputs.charts != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        chart: ${{ fromJson(needs.detect-changes.outputs.charts) }}
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: latest

      - name: Install cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: Install ORAS
        uses: oras-project/setup-oras@v1

      - name: Install yq
        run: |
          # renovate: datasource=github-releases depName=mikefarah/yq
          YQ_VERSION="4.44.3"
          wget -q https://github.com/mikefarah/yq/releases/download/v${YQ_VERSION}/yq_linux_amd64 -O yq
          chmod +x yq
          sudo mv yq /usr/local/bin/yq
          yq --version

      - name: Install helm-unittest plugin
        run: |
          helm plugin install https://github.com/helm-unittest/helm-unittest.git

      - name: Install check-jsonschema
        run: pip install check-jsonschema

      - name: Install Artifact Hub CLI
        run: |
          # renovate: datasource=github-releases depName=artifacthub/hub
          AH_VERSION="1.21.0"
          wget -q https://github.com/artifacthub/hub/releases/download/v${AH_VERSION}/ah_${AH_VERSION}_linux_amd64.tar.gz
          tar -xzf ah_${AH_VERSION}_linux_amd64.tar.gz
          chmod +x ah
          sudo mv ah /usr/local/bin/ah
          ah version

      - name: Get chart metadata
        id: chart-metadata
        run: |
          CHART_PATH="${{ matrix.chart }}"
          CHART_NAME=$(yq eval '.name' "${CHART_PATH}/Chart.yaml")
          CHART_VERSION=$(yq eval '.version' "${CHART_PATH}/Chart.yaml")
          APP_VERSION=$(yq eval '.appVersion' "${CHART_PATH}/Chart.yaml")

          echo "path=${CHART_PATH}" >> $GITHUB_OUTPUT
          echo "name=${CHART_NAME}" >> $GITHUB_OUTPUT
          echo "version=${CHART_VERSION}" >> $GITHUB_OUTPUT
          echo "app_version=${APP_VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${CHART_NAME}-${CHART_VERSION}" >> $GITHUB_OUTPUT

          echo "Chart: ${CHART_NAME} v${CHART_VERSION} (app: ${APP_VERSION})"

      - name: Check if version already exists
        id: check-version
        run: |
          if gh release view "${{ steps.chart-metadata.outputs.tag }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release ${{ steps.chart-metadata.outputs.tag }} already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Release ${{ steps.chart-metadata.outputs.tag }} does not exist"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run validation tests
        if: steps.check-version.outputs.exists == 'false'
        run: |
          CHART_PATH="${{ steps.chart-metadata.outputs.path }}"
          CHART_NAME="${{ steps.chart-metadata.outputs.name }}"

          echo "Running validation for ${CHART_NAME} v${{ steps.chart-metadata.outputs.version }}"

          # Lint
          helm lint "${CHART_PATH}"

          # Schema validation (if schema exists)
          if [ -f "${CHART_PATH}/values.schema.json" ]; then
            check-jsonschema --schemafile "${CHART_PATH}/values.schema.json" "${CHART_PATH}/values.yaml"
          else
            echo "No schema found, skipping schema validation"
          fi

          # Unit tests (if tests exist)
          if [ -d "${CHART_PATH}/tests" ]; then
            helm unittest "${CHART_PATH}" --color
          else
            echo "No tests found, skipping unit tests"
          fi

          # Artifact Hub lint
          echo "Running Artifact Hub lint for ${CHART_NAME}"
          ah lint --kind helm --path "${CHART_PATH}"

      - name: Login to GitHub Container Registry
        if: steps.check-version.outputs.exists == 'false'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Package and push chart
        if: steps.check-version.outputs.exists == 'false'
        id: push
        run: |
          CHART_PATH="${{ steps.chart-metadata.outputs.path }}"
          CHART_NAME="${{ steps.chart-metadata.outputs.name }}"
          CHART_VERSION="${{ steps.chart-metadata.outputs.version }}"

          # Package chart
          helm package "${CHART_PATH}"

          # Push to GHCR and capture output
          CHART_FILE="${CHART_NAME}-${CHART_VERSION}.tgz"
          helm push "${CHART_FILE}" oci://ghcr.io/${{ github.repository_owner }}/charts > /tmp/push-output.txt 2>&1
          cat /tmp/push-output.txt

          # Extract digest from helm push output
          DIGEST=$(awk '/Digest: /{print $2}' /tmp/push-output.txt)
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
          echo "Pushed chart with digest: ${DIGEST}"

      - name: Sign chart with cosign
        if: steps.check-version.outputs.exists == 'false'
        run: |
          IMAGE_URI="ghcr.io/${{ github.repository_owner }}/charts/${{ steps.chart-metadata.outputs.name }}@${{ steps.push.outputs.digest }}"
          echo "Signing ${IMAGE_URI}"
          cosign sign --yes "${IMAGE_URI}"
          echo "Chart signed successfully"

      - name: Publish Artifact Hub metadata
        if: steps.check-version.outputs.exists == 'false'
        run: |
          CHART_PATH="${{ steps.chart-metadata.outputs.path }}"
          CHART_NAME="${{ steps.chart-metadata.outputs.name }}"

          # Check if artifacthub-repo.yml exists in the chart directory
          if [ -f "${CHART_PATH}/artifacthub-repo.yml" ]; then
            echo "Publishing Artifact Hub metadata for ${CHART_NAME}"

            # Push metadata file to OCI registry with special tag
            oras push \
              ghcr.io/${{ github.repository_owner }}/charts/${CHART_NAME}:artifacthub.io \
              --config /dev/null:application/vnd.cncf.artifacthub.config.v1+yaml \
              ${CHART_PATH}/artifacthub-repo.yml:application/vnd.cncf.artifacthub.repository-metadata.layer.v1.yaml

            echo "Artifact Hub metadata published successfully"
          else
            echo "No artifacthub-repo.yml found in ${CHART_PATH}, skipping metadata publishing"
          fi

      - name: Extract changelog
        if: steps.check-version.outputs.exists == 'false'
        id: changelog
        run: |
          CHART_PATH="${{ steps.chart-metadata.outputs.path }}"
          CHART_NAME="${{ steps.chart-metadata.outputs.name }}"
          CHART_VERSION="${{ steps.chart-metadata.outputs.version }}"
          APP_VERSION="${{ steps.chart-metadata.outputs.app_version }}"

          CHANGELOG_RAW=$(yq eval '.annotations."artifacthub.io/changes"' "${CHART_PATH}/Chart.yaml")

          # Build changelog section first
          CHANGELOG_SECTION=""
          if [ "$CHANGELOG_RAW" != "null" ] && [ -n "$CHANGELOG_RAW" ]; then
            CHANGELOG_SECTION="### Changelog

          "
            TEMP_FILE=$(mktemp)
            SEPARATOR="|"
            echo "$CHANGELOG_RAW" | yq eval ".[] | .kind + \"${SEPARATOR}\" + .description" - > "$TEMP_FILE"

            while IFS="${SEPARATOR}" read -r kind description; do
              case "$kind" in
                "added")
                  emoji="✨"
                  ;;
                "changed")
                  emoji="🔄"
                  ;;
                "deprecated")
                  emoji="⚠️"
                  ;;
                "removed")
                  emoji="🗑️"
                  ;;
                "fixed")
                  emoji="🐛"
                  ;;
                "security")
                  emoji="🔒"
                  ;;
                *)
                  emoji="📝"
                  ;;
              esac
              CHANGELOG_SECTION="${CHANGELOG_SECTION}- ${emoji} ${description}
          "
            done < "$TEMP_FILE"

            rm -f "$TEMP_FILE"
            CHANGELOG_SECTION="${CHANGELOG_SECTION}
          "
          fi

          # Build release body with changelog first
          RELEASE_BODY="## Chart: ${CHART_NAME} v${CHART_VERSION}

          **App Version**: ${APP_VERSION}

          ${CHANGELOG_SECTION}### Installation

          \`\`\`bash
          helm install ${CHART_NAME} \\
            oci://ghcr.io/${{ github.repository_owner }}/charts/${CHART_NAME} \\
            --version ${CHART_VERSION}
          \`\`\`

          ### Verification

          \`\`\`bash
          cosign verify \\
            ghcr.io/${{ github.repository_owner }}/charts/${CHART_NAME}:${CHART_VERSION} \\
            --certificate-identity \"https://github.com/${{ github.repository }}/.github/workflows/publish-oci.yaml@refs/heads/master\" \\
            --certificate-oidc-issuer \"https://token.actions.githubusercontent.com\"
          \`\`\`

          ---

          📦 **Published to**: \`ghcr.io/${{ github.repository_owner }}/charts/${CHART_NAME}:${CHART_VERSION}\`
          🔐 **Signed with**: cosign (keyless)
          📝 **Transparency log**: [Rekor](https://rekor.sigstore.dev/)
          "

          # Save to file for gh release create
          echo "$RELEASE_BODY" > release-notes.md

      - name: Create GitHub Release
        if: steps.check-version.outputs.exists == 'false'
        run: |
          gh release create "${{ steps.chart-metadata.outputs.tag }}" \
            --title "${{ steps.chart-metadata.outputs.name }} v${{ steps.chart-metadata.outputs.version }}" \
            --notes-file release-notes.md \
            "${{ steps.chart-metadata.outputs.name }}-${{ steps.chart-metadata.outputs.version }}.tgz"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: steps.check-version.outputs.exists == 'false'
        run: |
          echo "## 🚀 Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Chart**: ${{ steps.chart-metadata.outputs.name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.chart-metadata.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **App Version**: ${{ steps.chart-metadata.outputs.app_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: \`ghcr.io/${{ github.repository_owner }}/charts/${{ steps.chart-metadata.outputs.name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Signed**: ✅ (cosign keyless)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "helm install ${{ steps.chart-metadata.outputs.name }} \\" >> $GITHUB_STEP_SUMMARY
          echo "  oci://ghcr.io/${{ github.repository_owner }}/charts/${{ steps.chart-metadata.outputs.name }} \\" >> $GITHUB_STEP_SUMMARY
          echo "  --version ${{ steps.chart-metadata.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Version already exists
        if: steps.check-version.outputs.exists == 'true'
        run: |
          echo "## ℹ️ Version Already Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Release **${{ steps.chart-metadata.outputs.tag }}** already exists." >> $GITHUB_STEP_SUMMARY
          echo "No action taken." >> $GITHUB_STEP_SUMMARY
