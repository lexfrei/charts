name: Publish Helm Charts

on:
  push:
    branches:
      - master
  pull_request:
    branches-ignore:
      - "**"

jobs:
  publish-charts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Helm
        run: |
          curl -sSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Install GPG v1
        run: |
          sudo apt-get update && sudo apt-get install -y gnupg1
          mkdir -p ~/.gnupg
          echo "use-agent" >> ~/.gnupg/gpg.conf

      - name: Import GPG key
        run: echo "$GPG_PRIVATE_KEY" | gpg --batch --import --no-default-keyring --keyring ~/.gnupg/secring.gpg
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}

      - name: Package Helm Charts
        run: |
          mkdir -p .deploy
          for chart in charts/*/; do
            if [ -d "$chart" ]; then
              echo "Packaging and signing chart: $(basename "$chart")"
              helm package "$chart" --destination .deploy --sign --key "Aleksey Sviridkin" --keyring ~/.gnupg/secring.gpg
            fi
          done

      - name: Update Helm repository index
        run: |
          git fetch origin gh-pages
          git checkout gh-pages
          mv .deploy/*.tgz .
          mv .deploy/*.tgz.prov .
          helm repo index . --merge index.yaml
          git add .
          git commit -m "Update Helm charts" || echo "No changes to commit"
          git push origin gh-pages
