name: Publish Helm Charts

on:
  push:
    branches:
      - master
  pull_request:
    branches-ignore:
      - "**"

jobs:
  publish-charts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Helm
        run: |
          curl -sSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Import GPG private key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          set -o pipefail && set -e
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          gpg --list-secret-keys --keyid-format LONG

      - name: Package and sign Helm charts
        env:
          GPG_FINGERPRINT: "62516FAA4167CBF4FA4E0775CF943E8B90C984F5"
        run: |
          mkdir -p .deploy
          for chart in charts/*/; do
            if [ -d "$chart" ]; then
              echo "Packaging and signing chart: $(basename "$chart")"
              helm package "$chart" --destination .deploy --sign --key "$GPG_FINGERPRINT" --keyring ~/.gnupg/pubring.kbx
            fi
          done

      - name: Update Helm repository index
        run: |
          git fetch origin gh-pages
          git checkout gh-pages
          mv .deploy/*.tgz .
          mv .deploy/*.tgz.prov .
          helm repo index . --merge index.yaml
          git add .
          git commit -m "Update Helm charts" || echo "No changes to commit"
          git push origin gh-pages

      - name: Clean up GPG key
        run: |
          gpg --batch --yes --delete-secret-keys "$GPG_FINGERPRINT"
          gpg --batch --yes --delete-key "$GPG_FINGERPRINT"
